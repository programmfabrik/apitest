<!DOCTYPE html>
<html lang="en">
<head>

<title>apitest mock SMTP server GUI</title>
<style>
html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: monospace; }
body { padding: 20px; box-sizing: border-box; }
noscript { color: red; font-weight: bold; }
.container { display: flex; flex-direction: row; gap: 20px; }
.container nav { flex: 2; }
.container main { flex: 1; }
table, th, td { border: 2px solid grey; border-collapse: collapse; }
th, td { padding: 10px; }
.subject-hdr { width: 100%; }
pre { background-color: #eee; padding: 10px; box-sizing: border-box; width: 100%; overflow-x: auto; }
main > h4:first-of-type { padding-top: 0; margin-top: 0; }
</style>

</head>

<body>
<noscript>This GUI needs JavaScript to function properly.</noscript>

<div class="container">
    <nav>
        <table>
            <thead>
                <tr>
                    <th>Index</th>
                    <th>Received</th>
                    <th>From</th>
                    <th>To</th>
                    <th class="subject-hdr">Subject</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="indexrows"></tbody>
        </table>
    </nav>

    <main id="detailpanel"></main>
</div>

<script>
const prefix = "{{ .prefix }}"

const detailpanel = document.getElementById("detailpanel")
const indexrows = document.getElementById("indexrows")

let n_received = 0
let index = {"count": 0, "messages": []}

async function updateIndex() {
    response = await fetch(prefix + "/")
    index = await response.json()

    for (; n_received < index["count"]; n_received++) {
        const msg = index["messages"][n_received]

        let row = indexrows.insertRow()
        let cell = row.insertCell()
        cell.textContent = msg["idx"]
        cell = row.insertCell()
        cell.textContent = msg["receivedAt"]
        cell = row.insertCell()
        cell.textContent = msg["from"]
        cell = row.insertCell()
        cell.textContent = msg["to"]
        cell = row.insertCell()
        cell.textContent = msg["subject"]
        cell = row.insertCell()
        cell.innerHTML = `<button onclick="javascript:showDetails(${n_received})">Show</button>`
    }
}

async function addContentLinks(parentElement, metadata, linkPrefix, idx) {
    let contentType = metadata["contentType"]
    if (contentType === "") {
        contentType = "unspecified"
    }

    let li = document.createElement("li")
    parentElement.append(li)

    let a = document.createElement("a")
    li.append(a)
    a.href = `${linkPrefix}/body`
    a.textContent = `${idx}: Content-Type ${contentType}`
    a.target = "_blank"

    if (metadata["isMultipart"] === true) {
        let ul = document.createElement("ul")
        li.append(ul)

        for (let i=0; i < metadata["multipartsCount"]; i++) {
            addContentLinks(ul, metadata["multiparts"][i], `${linkPrefix}/multipart/${i}`, i)
        }
    }
}

async function showDetails(idx) {
    response = await fetch(`${prefix}/${idx}`)
    metadata = await response.json()

    detailpanel.innerHTML=""

    let raw_heading = document.createElement("h4")
    detailpanel.append(raw_heading)
    raw_heading.textContent = "Raw Message:"
    let raw_a = document.createElement("a")
    detailpanel.append(raw_a)
    raw_a.href = `${prefix}/${idx}/raw`
    raw_a.target = "_blank"
    raw_a.textContent = "Download"

    let body_heading = document.createElement("h4")
    detailpanel.append(body_heading)
    body_heading.textContent = "Body / Multiparts:"
    let body_ul = document.createElement("ul")
    detailpanel.append(body_ul)
    addContentLinks(body_ul, metadata, `${prefix}/${idx}`, 0)

    let metadata_heading = document.createElement("h4")
    detailpanel.append(metadata_heading)
    metadata_heading.textContent = "Message Metadata:"
    let metadata_pre = document.createElement("pre")
    detailpanel.append(metadata_pre)
    metadata_pre.textContent = JSON.stringify(metadata, null, 2)
}

updateIndex()
setInterval(updateIndex, 1000)
</script>

</body>
</html>
